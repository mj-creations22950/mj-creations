rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {
    function isAuth(){ return request.auth != null }
    function role(){ return get(/databases/$(db)/documents/users/$(request.auth.uid)).data.role }

    match /users/{uid} {
      allow read: if isAuth() && (uid==request.auth.uid || role() in ['admin','commercial','comptable']);
      allow write: if isAuth() && (uid==request.auth.uid || role()=='admin');
    }

    match /prospects/{id} { allow read, write: if isAuth() && role() in ['admin','commercial']; }
    match /services/{id}  { allow read: if true; allow write: if isAuth() && role()=='admin'; }
    match /planning/{d}/{sub=**} { allow read, write: if isAuth() && role() in ['admin','commercial']; }
    match /clients/{cid}/{sub=**} { allow read, write: if isAuth() && (role() in ['admin','commercial','comptable'] || request.auth.uid==cid); }
    match /chantiers/{id} { allow read: if isAuth(); allow write: if isAuth() && role() in ['admin','commercial']; }
    match /comptabilite/{exo}/{col=**} { allow read, write: if isAuth() && role() in ['admin','comptable']; }
    match /achats/{id} { allow read, write: if isAuth() && role() in ['admin','comptable']; }
    match /banque/{id} { allow read, write: if isAuth() && role() in ['admin','comptable']; }
  }
}
