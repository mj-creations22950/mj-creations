<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MJ Seed • Firestore</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#0b1220;color:#e5e7eb}
    .wrap{max-width:800px;margin:0 auto;padding:32px}
    .card{background:#111827;border-radius:14px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    input,button{font-size:16px}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #1f2937;background:#0f172a;color:#e5e7eb}
    label{display:block;margin:8px 0 6px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mt{margin-top:14px}
    .btn{background:#2563eb;border:none;color:#fff;padding:10px 16px;border-radius:12px;cursor:pointer}
    pre{white-space:pre-wrap;background:#0f172a;padding:12px;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Seed Firestore — MJ Créations</h1>
    <p>Cette page crée des données minimales (prospect, RDV, chantier, facture) pour vérifier votre flux complet.</p>
    <div class="card">
      <label>UID Client (déjà créé dans Authentication)</label>
      <input id="uid" placeholder="ex: ZxY123..." />
      <div class="row">
        <div>
          <label>Nom client</label>
          <input id="nom" value="Client Test" />
        </div>
        <div>
          <label>Email client</label>
          <input id="email" value="client@example.com" />
        </div>
      </div>
      <button class="btn mt" id="run">Créer les données</button>
      <pre id="log" class="mt"></pre>
    </div>
  </div>
  <script src="./assets/js/firebase-config.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, setDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    const app = initializeApp(window.MJ_FIREBASE_CONFIG);
    const db = getFirestore(app);
    const log = (m)=> document.getElementById('log').textContent += m + "\n";
    document.getElementById('run').onclick = async ()=>{
      const uid=document.getElementById('uid').value.trim();
      const nom=document.getElementById('nom').value.trim();
      const email=document.getElementById('email').value.trim();
      if(!uid){ alert('Renseignez UID client'); return; }
      try{
        await setDoc(doc(db,'clients', uid), { infos:{ nom, email, dateCreation: new Date().toISOString() }});
        log('✔ Client créé/à jour');
        const pr= await addDoc(collection(db,'prospects'), {
          demande:{ services:['salle-bain:renovation-complete'], mesures:'10 m²', localisation:'Paris' },
          statut:'nouveau', estimation:{ montant: 5000 }, commercial:{ assigne:null }, createdAt: serverTimestamp()
        });
        log('✔ Prospect créé: '+pr.id);
        const iso=(new Date()).toISOString().slice(0,10);
        const rdv= await addDoc(collection(db,`planning/${iso}/rendezVous`), { heure:'11:00', client: nom, type:'visite', artisan:'à planifier' });
        log('✔ RDV créé: '+rdv.id);
        const ch = await addDoc(collection(db,'chantiers'), {
          clientId: uid,
          details:{ titre:'Rénovation SDB', description:'Douche italienne + carrelage', statut:'planifié', dates:{ debut: iso }},
          progression:{ percent: 10 }, equipe:{ chef:'—', artisans:[] }, financier:{ devis: 6000, acompte: 0, factures: [] }
        });
        log('✔ Chantier créé: '+ch.id);
        const f = await addDoc(collection(db,`clients/${uid}/factures`), {
          num:'F'+new Date().getFullYear()+'-'+Math.floor(Math.random()*900+100),
          client: nom, date: iso, lines:[{ label:'Rénovation SDB', q:1, pu:6000, vat:10 }],
          ht:6000, vat:600, ttc:6600, status:'envoyee', createdAt: serverTimestamp()
        });
        log('✔ Facture créée: '+f.id);
        log('\nTerminé. Ouvre Portail client et Interface comptable pour vérifier le flux.');
      }catch(e){ log('✖ Erreur: '+(e&&e.message?e.message:e)); }
    };
  </script>
</body>
</html>
